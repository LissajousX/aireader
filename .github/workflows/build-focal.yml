name: Build Focal AppImage

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_INCREMENTAL: 0

jobs:
  build-focal:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lissajousx/aireader-focal-build:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      PKG_CONFIG_PATH: /usr/local/lib/x86_64-linux-gnu/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/share/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug pkg-config for JavaScriptCore
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          find /usr -name 'javascriptcoregtk-*.pc' -o -name 'webkit2gtk-*.pc' || true
          pkg-config --list-all | grep -E 'javascriptcoregtk|webkit2gtk' || true
          echo "--- pc file content ---"
          cat /usr/lib/x86_64-linux-gnu/pkgconfig/javascriptcoregtk-4.1.pc || true
          echo "--- pkg-config requires ---"
          pkg-config --print-requires javascriptcoregtk-4.1 || true
          echo "--- pkg-config cflags/libs (with debug) ---"
          PKG_CONFIG_DEBUG_SPEW=1 pkg-config --cflags --libs javascriptcoregtk-4.1 || true

      - name: Inject version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Injecting version: $VERSION"
          cd src-tauri
          python3 -c "
          import json
          with open('tauri.conf.json', 'r') as f: c = json.load(f)
          c['version'] = '$VERSION'
          with open('tauri.conf.json', 'w') as f: json.dump(c, f, indent=2, ensure_ascii=False)
          print(f'Updated tauri.conf.json version to {c["version"]}')"
          grep '"version"' tauri.conf.json

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app (AppImage for focal)
        env:
          CARGO_INCREMENTAL: "0"
        run: npx tauri build --target x86_64-unknown-linux-gnu --bundles appimage

      - name: Rename AppImage (mark as focal-compatible)
        shell: bash
        run: |
          cd src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage
          for f in *.AppImage; do
            mv "$f" "${f%.AppImage}-ubuntu2004.AppImage"
          done
          ls -lh *.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aireader-x86_64-linux-focal
          path: src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
          if-no-files-found: error

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
